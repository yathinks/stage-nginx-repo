
server {
    listen 100;
    listen 100 ssl;
    ssl_certificate /etc/nginx/api_certificates_conf.d/nginx-repo.crt;
    ssl_certificate_key /etc/nginx/api_certificates_conf.d/nginx-repo.key;
    ssl_protocols SSLv2;
    ssl_ciphers ALL;
    ssl_session_timeout 5000s;
    keepalive_timeout 5000s;
    limit_req_zone  $binary_remote_addr zone=apiwiz:10m rate=1r/s;
    limit_req  zone=apiwiz  burst=1 nodelay;
    server_tokens  key;
    server_tokens  key;
    pid  level-1;
    error_page  qdwed wdewed;
    proxy_cache_path  test levels=test use_temp_path=test keys_zone=:89  inactive=13  max_size=123  min_free=23  manager_files=121 manager_sleep=test manager_threshold=test  loader_files=122 loader_sleep=test loader_threshold=test purger=test  purger_files=33 purger_sleep=test purger_threshold=test;
    status_zone ;
    status_zone ;
    include /etc/nginx/api_conf.d/*.conf;
    location = /_validate_apikey {
        internal;

        if ($http_apikey = "") {
            return 401; # Unauthorized
        }
        if ($api_client_name = "") {
            return 403; # Forbidden
        }

        return 204; # OK (no content)
    }
    location /apiwiz-compliance {
        proxy_ssl_server_name on;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Content-Type application/json;
        proxy_set_header x-client-id acme-team-gcp-dev;
        proxy_set_header x-client-secret XeX0u28Ya1a3CBm5tihMQFteeA6fZTy8avUIsJ0WnNOaEAM90Hcv9G2xo5z5hI4WMyHffxTAbP2LcXK4u6n5Pw==;
        proxy_pass https://gcp-api.apiwiz.io/v1/compliance/detect;
    }
}
